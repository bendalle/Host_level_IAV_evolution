---
title: "mutational model"
author: "JT McCrone"
date: "4/18/2017"
output: github_document
---

```{r,echo=F}
# Set up packages
require(knitr)
require(ggplot2)
require(magrittr)
require(tidyverse)
if(!("package:tidyverse" %in% search())){
  require(dplyr)
  require(tidyr)
  require(purrr)
  require(readr)
  require(rlang)
}
require(HIVEr)
require(extrafont)
require(wesanderson)
require(grid)
set.seed(42) # Set seed so randomization is reproducible

# Set up figures
opts_chunk$set(fig.align="center",warning=TRUE,tidy=T,cache = T,echo=F)
theme_set(new = theme_classic()+ theme(
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour ='black',size=0.5,linetype='solid'),
text=element_text(family="Arial",size = 18))) # to make nice plots
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbPalette<-wes_palette("Zissou")
# Get widely used functions
#source("../scripts/useful_functions.R")


####### Write to summary results file ######
write_to_summary<-function(line_pattern,value){
  file = readLines("./results.table.tsv")
  line_pattern_regex = paste0("^",line_pattern)
  line = grep(line_pattern_regex,file)
  file[line] = paste0(line_pattern,"\t",value)
  writeLines(file,"./results.table.tsv")
}
require(cowplot)
# Frequency distribution


```{r}
qual <-read_csv("../data/processed/secondary/qual.snv.csv",
               col_types = list(
                 ENROLLID= col_character(),
                 SPECID = col_character(),
                 LAURING_ID = col_character(),
                 Id = col_character()
               ))

meta_one<-read_csv("../data/reference/all_meta.sequence_success.csv")

qual_min <- subset(qual,freq.var<0.5)
qual_min <- subset(qual_min,!(SPECID %in% c("HS1530","MH8137","MH8390"))) # ,"M54062" probabily mixed
qual_min<-qual_min %>% filter(SPECID %in% meta_one$SPECID) # Only get 1 sample person
qual_min<-mutate(qual_min,DPI = collect-(onset-1))
qual_min<-subset(qual_min,DPI>0)# & DPI<=3)


```

```{r}
ggplot(qual_min,aes(x=freq.var,fill=as.factor(DPI))) +geom_density(alpha=0.5)
```
# Estimating $N_e$ and $\mu_e$
The goal here is to allow for the mutations to enter the system at a given rate so that we can go backwards in time when we need to. Here we are relying on the assumption that no polymorphisms are present at the start of infection

Here the probability function for $0<f<1$ is given by


$$
g(f,t) = \frac{2 \mu N_e}{f} e^{- \frac{2N_ef}{t}}
$$
I am assumining anything present at less than 0.001 is present at 0.


# 6 hours

```{r}
base<-seq(1,9,1)
power<- -6  #seq(-7,-5,1)
Ne <- seq(10,80,1)

mu.df<-expand.grid(base,power)
mu = mu.df$Var1*10^mu.df$Var2

parameters<-expand.grid(mu,Ne)
names(parameters)<-c("mu","Ne")


output<- parameters %>% rowwise()%>%
  mutate(LL = mut_model_LL(qual_min,mu,Ne,gen_time=6,neg=F,acc=accuracy_stringent)) 


```

```{r}
require(cowplot)
top<-output[output$LL==max(output$LL),]
write_to_summary("Mu:",top$mu)
write_to_summary("Ne_spec:",top$Ne)
kable(top)
CI = output[top$LL-output$LL<1.92,]

tiles.p<-ggplot(output,aes(x=Ne,y=mu,z=LL))+geom_point(data=top,aes(x=Ne,y=mu))+scale_y_log10(breaks = seq(1e-6,1e-5,1e-6))+stat_contour(breaks = c(-4688,seq(-4698,-5000,by=-30)),aes(color = ..level..),show.legend = F)

 tiles.p<-direct.label(tiles.p,list("bottom.pieces"))
save_plot("./Figures/Figure4.pdf", tiles.p,
          base_aspect_ratio = 1.3)

embed_fonts("./Figures/Figure4.pdf")

write.csv(rename(output,Log.likelihood=LL),"./Figures/data/Figure4.csv")
tiles.p

```



# 12 hours

```{r,eval=F}
base<-seq(1,9,1)
power<- -6  #seq(-7,-5,1)
Ne <- seq(1,20,1)

mu.df<-expand.grid(base,power)
mu = mu.df$Var1*10^mu.df$Var2

parameters<-expand.grid(mu,Ne)
names(parameters)<-c("mu","Ne")


output<- parameters %>% rowwise()%>%
  mutate(LL = mut_model_LL(qual_min,mu,Ne,gen_time=6,neg=F,acc=accuracy_stringent)) 

```

```{r,eval=F}
library(plotly)
top<-output[output$LL==max(output$LL),]
kable(top)
CI = output[top$LL-output$LL<1.92,]

tiles.p<-ggplot(output,aes(x=Ne,y=mu))+geom_contour(aes(x=Ne,y=mu,z=LL),color="black")+geom_point(data=top,aes(x=Ne,y=mu))+scale_y_log10(breaks = seq(1e-6,1e-5,1e-6))

tiles.p
save_plot("./Figures/contour_12.pdf", tiles.p,
          base_aspect_ratio = 1.3)

embed_fonts("./Figures/contour_12.pdf")

Ne.cut<-subset(output,Ne==top$Ne)
mu.cut<-subset(output,mu==top$mu)

Ne.p<-ggplot(mu.cut,aes(x=Ne,y=LL))+geom_point()+geom_line()+scale_x_continuous(limits= c(22,40),breaks=c(22:40))+scale_y_continuous(limits= c(-3250,-3225))
Ne.p
#ggplotly(Ne.p)
mu.p<-ggplot(Ne.cut,aes(x=mu,y=LL))+geom_point()+geom_line()+scale_x_log10(breaks = seq(1e-6,1e-5,1e-6),labels = c(1:10))+xlab("mu (x10-6)")
mu.p
require(cowplot)


save_plot("./Figures/mu_12.p.pdf", mu.p,
          base_aspect_ratio = 1.3)
embed_fonts("./Figures/mu_12.p.pdf")
save_plot("./Figures/Ne_12.p.pdf", Ne.p,
          base_aspect_ratio = 1.3)
embed_fonts("./Figures/Ne_12.p.pdf")


```
